<dom-module id="my-notes">
  <style>
    :host {
      display: block;
    }
    .search-container {
      width: 100%;
    @apply(--layout-horizontal);
    }
    .search-input {
      marign-left: 10px;
      margin-right: 5px;
      --paper-input-container-color: var(--text-primary-color);
      --paper-input-container-focus-color: var(--text-primary-color);
      --paper-input-container-input-color: var(--text-primary-color);
    @apply(--layout-flex);
    }
    .use-keywords {
      margin-top: 34px;
      margin-right: 5px;
      --paper-checkbox-unchecked-color: var(--text-primary-color);
      --paper-checkbox-checked-color: var(--accent-color);
      --paper-checkbox-label-color: var(--text-primary-color);
    }
    .clear-search {
      margin-top: 25px;
    }
    .style-notes {
      height: 620px;
      margin: 10px;
      overflow: auto;
    }
    .style-card-fab {
      position: absolute !important;
      top: 43px;
      right: 30px;
      z-index: 15;
    }
    .style-all-cards {
      margin-left: 5px;
      margin-top: 10px;
      margin-bottom: 10px;
      width: 98%;
    }
    .style-card {
      margin-top: 10px;
      border-radius: 4px;
      background-color: var(--text-primary-color);
    }
    paper-toolbar {
      word-wrap: break-word;
    }
    paper-input {
      margin-left: 15px;
      margin-right: 40px;
      width: 50%;
    }
    paper-checkbox{
      margin-left: 15px;
      margin-right: 40px;
    }
    p{
      padding-left: 10px;
      padding-bottom: 5px;
      margin-top: 20px;
      margin-bottom: 5px;
      width: 90%;
    }
    a {
      word-wrap: break-word;
      margin: 10px 10px 0 0;
      padding: 10px 10px 0 0;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    @media all and (min-width: 0) and (max-width: 361px) and (orientation: portrait) {
      .style-notes {
        height: 470px;
      }
      .search-input {
        margin-top: -2px;
      }
      .use-keywords {
        margin-top: 32px;
      }
      .clear-search {
        margin-top: 23px;
      }
      .style-all-cards {
        margin-top: 15px;
      }
      .style-card-fab {
        position: absolute !important;
        top: 35px;
        right: 10px;
        z-index: 15;
      }
      paper-input {
        width: 90%;
      }
    }
    @media all and (min-width: 1601px) and (max-width: 1921px) {
      .style-notes {
        height: 725px;
        margin: 10px;
        overflow: auto;
      }
    }
  </style>
  <template>
    <paper-material elevation="3">
      <paper-toolbar>
        <div class="search-container">
          <paper-input class="search-input" id="txtSearch" label="Search" type="text" value="{{searchStr}}"></paper-input>
          <paper-checkbox class="use-keywords" id="chbKeywords">Keywords</paper-checkbox>
          <paper-icon-button class="clear-search" icon="clear" on-click="_clearSearch"></paper-icon-button>
        </div>
      </paper-toolbar>
    </paper-material>

    <div id="divNotes" class="style-notes">
      <template id="templateNotes" is="dom-repeat" items="{{noteCollection}}" as="userObj">
        <div id="collectionAllCard" class="style-all-cards">
          <template is="dom-repeat" items="{{userObj}}" as="item">
            <template is="dom-if" if="{{_hasItemId(item)}}">
              <template is="dom-if" if="{{_searchForItems(item, searchStr)}}">
                <paper-material class="style-card" elevation="3">
                  <paper-toolbar>
                    <h3><span>{{item.title}}</span></h3>
                  </paper-toolbar>
                  <paper-fab class="style-card-fab" mini icon="clear" on-click="remove"></paper-fab>
                  <p><a href="{{item.value}}" target="_blank">{{item.value}}</a></p>
                  <p><strong>{{item.keywords}}</strong></p>
                </paper-material>
              </template>
            </template>
          </template>
        </div>
      </template>
    </div>
  </template>
</dom-module>

<script>
  (function() {
    Polymer({
      is: 'my-notes',

      /**
       * Load Items from Firebase
       */
      reloadNotes: function() {
        if (this.userInfo.isLoginExpired(this.userInfo.get(this.userInfo.EXPIREDATE))) {
          this.fire('login-expired');
          return;
        }

        var id = this.userInfo.get(this.userInfo.USERID);
        var that = this;

        var rootRef = new Firebase('https://yeah-url-extension.firebaseio.com/' + id + '/notescollector');
        rootRef.on('value', function(snapshot) {

          that.noteCollection = [];

          snapshot.forEach(function(child) {
            that.push('noteCollection', child.val());
          });
        });
      },

      /**
       * Remove selected Item from Firebase
       * @param e
       */
      remove: function(e) {
        if (this.userInfo.isLoginExpired(this.userInfo.get(this.userInfo.EXPIREDATE))) {
          this.fire('login-expired');
          return;
        }

        var model = e.model;
        var urlObj = model.item;

        var id = (urlObj.id - 1);
        var objId = urlObj.objId;
        var that = this;

        this._removeFromFirebase(id, objId)
          .then(function(obj) {
            that.fire('remove-item-successful', obj);
            that.reloadOverview();
          })
          .catch(function(err) {
            that.fire('remove-item-failed', err);
          });
      },

      /**
       * Remove it!
       * @param id
       * @param objId
       * @return {Promise}
       * @private
       */
      _removeFromFirebase: function(id, objId) {
        return new Promise(function(resolve, reject) {
          var userId = this.userInfo.get(this.userInfo.USERID);
          var ref = new Firebase('https://yeah-url-extension.firebaseio.com/' + userId + '/notescollector/' + objId + '/' + id);

          var onComplete = function(error) {
            if (error) reject(error);
            else resolve({'value':'remove successful'});
          };

          ref.remove(onComplete);
        });
      },

      /**
       * Check if Item as an Id
       * @param item
       * @return {boolean}
       * @private
       */
      _hasItemId: function(item) {
        return item.hasOwnProperty('id');
      },

      /**
       * Search for matching Items
       * @param item
       * @param searchStr
       * @return {Object, Array}
       * @private
       */
      _searchForItems: function(item, searchStr) {
        if (searchStr === null ||typeof searchStr === 'undefined') {
          return item;
        } else {
          return item.value.toLowerCase().match(searchStr.toLowerCase()) || item.keywords.toUpperCase().match(searchStr.toUpperCase());
        }
      },

      /**
       * Clear Search Input
       * @private
       */
      _clearSearch: function() {
        this.$.txtSearch.value = '';
        this.$.chbKeywords.checked = false;
      },

      /**
       * Clear Note List
       */
      clearListview: function() {
        var listView = document.querySelector('#divNotes');
        if (listView !== null) listView.innerHTML = '';
      },

      /**
       * Init Note Collection
       */
      ready: function() {
        this.userInfo = new UserInfo();
        this.noteCollection = [];

        var kwLabel = this.$.chbKeywords.querySelector('#checkboxLabel');
        if (window.matchMedia('(max-width: 361px)').matches) {
          kwLabel.innerText = 'KW';
        } else {
          kwLabel.innerText = 'Keywords';
        }
      }
    });
  })();
</script>
