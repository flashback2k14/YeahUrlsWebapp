<dom-module id="my-overview">
  <style>
    :host {
      display: block;
    }
    @media all and (min-width: 0) and (max-width: 361px) and (orientation: portrait) {
      #divOverview {
        height: 530px;
      }
      #fabCard {
        position: absolute !important;
        top: 0;
        right: 0;
        z-index: 15;
      }
      paper-input {
        width: 90%;
      }
    }
    @media all and (min-width: 1601px) and (max-width: 1920px) {
      #divOverview {
        height: 710px;
      }
    }
    .searchContainer {
      width: 100%;
      @apply(--layout-horizontal);
    }
    .searchInput {
      margin-top: 10px;
      marign-left: 10px;
      margin-right: 5px;
      --paper-input-container-color: var(--text-primary-color);
      --paper-input-container-focus-color: var(--text-primary-color);
      --paper-input-container-input-color: var(--text-primary-color);
      @apply(--layout-flex);
    }
    .useKeywords {
      margin-top: 44px;
      margin-right: 5px;
      --paper-checkbox-unchecked-color: var(--text-primary-color);
      --paper-checkbox-checked-color: var(--accent-color);
      --paper-checkbox-label-color: var(--text-primary-color);
    }
    .clearSearch {
      margin-top: 35px;
    }
    #divOverview {
      height: 620px;
      margin: 10px;
      overflow: auto;
    }
    #fabCard {
      position: absolute !important;
      top: 43px;
      right: 30px;
      z-index: 15;
    }
    paper-input {
      margin-left: 15px;
      margin-right: 40px;
      width: 50%;
    }
    paper-checkbox{
      margin-left: 15px;
      margin-right: 40px;
    }
    #collectionAllCard {
      margin-left: 5px;
      margin-top: 10px;
      margin-bottom: 10px;
      width: 98%;
    }
    #collectionCard {
      margin-top: 10px;
      border-radius: 4px;
      background-color: var(--text-primary-color);
    }
    paper-toolbar {
      word-wrap: break-word;
    }
    p{
      padding-left: 10px;
      padding-bottom: 5px;
      margin-top: 20px;
      margin-bottom: 5px;
      width: 90%;
    }
    a {
      word-wrap: break-word;
      margin: 10px 10px 0 0;
      padding: 10px 10px 0 0;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .with-tooltip {
      display: inline-block;
      margin-bottom: 20px;
      overflow: hidden;
    }
    .tooltip {
      --paper-tooltip-background: var(--accent-color);
    }
  </style>
  <template>
    <paper-material elevation="3">
      <paper-toolbar>
        <div class="searchContainer">
        <paper-input class="searchInput" id="txtSearch" label="Search" type="text" value="{{searchStr}}"></paper-input>
        <div class="with-tooltip">
          <paper-checkbox class="useKeywords" id="chbKeywords">Keywords</paper-checkbox>
          <paper-tooltip class="tooltip">Search inside the Keywords.</paper-tooltip>
        </div>
        <div class="with-tooltip">
          <paper-icon-button class="clearSearch" icon="clear" on-click="clearSearch"></paper-icon-button>
          <paper-tooltip class="tooltip">Clear Search Input.</paper-tooltip>
        </div>
      </div>
      </paper-toolbar>
    </paper-material>

    <div id="divOverview">
      <template id="templateOverview" is="dom-repeat" items="{{urlCollection}}" as="userObj">
        <div id="collectionAllCard">
            <template is="dom-repeat" items="{{userObj}}" as="item">
              <template is="dom-if" if="{{hasItemId(item)}}">
                <template is="dom-if" if="{{searchForItems(item, searchStr)}}">
                  <paper-material id="collectionCard" elevation="3">
                    <paper-toolbar>
                      <h3>Date:&nbsp;</h3><h3><span>{{item.date}}</span></h3>
                      <h3>,&nbsp;</h3><h3><span>{{item.time}}</span></h3>
                    </paper-toolbar>
                    <paper-fab id="fabCard" mini icon="clear" on-click="remove"></paper-fab>
                    <p><a href="{{item.value}}" target="_blank">{{item.value}}</a></p>
                    <p><strong>{{item.keywords}}</strong></p>
                  </paper-material>
                </template>
              </template>
            </template>
        </div>
      </template>
    </div>
  </template>
</dom-module>

<script>
  (function() {
    Polymer({
      is: 'my-overview',

      reloadOverview: function() {
        var id = UserInfo.get(UserInfo.USERID);
        var that = this;

        if (Util.isUserLoginExpired(UserInfo.get(UserInfo.EXPIREDATE))) {
          this.fire('login-expired');
          return;
        }

        var rootRef = new Firebase('https://yeah-url-extension.firebaseio.com/' + id + '/urlcollector');
        rootRef.on('value', function(snapshot) {

          that.urlCollection = [];

          snapshot.forEach(function(child) {
            var urlObjs = child.val();
            var objId = child.key();

            urlObjs = that._addObjIdToUrlCollection(urlObjs, objId);
            that.push('urlCollection', urlObjs);
          });
        });
      },

      _addObjIdToUrlCollection: function(urlColl, objId) {
        for (var i = 0; i < urlColl.length; i++) {
          if (typeof urlColl[i] !== 'undefined') {
            if (!urlColl[i].hasOwnProperty('objId')) {
              urlColl[i].objId = objId;
            }
          }
        }
        return urlColl;
      },

      _removeFromFirebase: function(id, objId) {
        return new Promise(function(resolve, reject) {
          var userId = UserInfo.get(UserInfo.USERID);
          var ref = new Firebase('https://yeah-url-extension.firebaseio.com/' + userId + '/urlcollector/' + objId + '/' + id);

          var onComplete = function(error) {
            if (error) reject(error);
            else resolve({'value':'remove successful'});
          };

          ref.remove(onComplete);
        });
      },

      remove: function(e) {
        var model = e.model;
        var urlObj = model.item;

        var id = (urlObj.id - 1);
        var objId = urlObj.objId;
        var that = this;

        this._removeFromFirebase(id, objId)
          .then(function(obj) {
            that.fire('remove-item-successful', obj);
            that.reloadOverview();
          })
          .catch(function(err) {
            that.fire('remove-item-failed', err);
          });
      },

      hasItemId: function(item) {
        return item.hasOwnProperty('id');
      },

      searchForItems: function(item, searchStr) {
        var useKeywords = this.$.chbKeywords.checked;

        if (searchStr !== undefined) {
          if (searchStr.length === 0) return item;
          else {
            if (useKeywords) return item.keywords.toLowerCase().match(searchStr.toLowerCase());
            else return item.value.toLowerCase().match(searchStr.toLowerCase());
          }
        } else {
          return this.urlCollection;
        }
      },

      clearSearch: function() {
        this.$.txtSearch.value = '';
        this.$.chbKeywords.checked = false;
      },

      clearListview: function() {
        var listView = document.querySelector('#collectionAllCard');
        listView.innerHTML = '';
      },

      ready: function() {
        this.urlCollection = [];
        var app = document.querySelector('#app');
        if (app.docReady) {
          this.reloadOverview();
        }
      }
    });
  })();
</script>
