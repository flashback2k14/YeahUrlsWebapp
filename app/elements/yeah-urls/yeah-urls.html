<dom-module id='yeah-urls'>
  <template>
    <!-- Element Styling -->
    <style>
      :host {
        display: block;
      }
      .style-overview {
        height: 620px;
        margin: 10px;
        overflow: auto;
      }
      .style-all-cards {
        margin-left: 5px;
        margin-top: 10px;
        margin-bottom: 10px;
        width: 98%;
      }
      paper-input {
        margin-left: 15px;
        margin-right: 40px;
        width: 50%;
      }
      @media all and (min-width: 0) and (max-width: 361px) and (orientation: portrait) {
        .style-overview {
          height: 470px;
        }
        .style-all-cards {
          margin-top: 15px;
        }
        paper-input {
          width: 90%;
        }
      }
      @media all and (min-width: 1601px) and (max-width: 1921px) {
        .style-overview {
          height: 725px;
          margin: 10px;
          overflow: auto;
        }
      }
    </style>
    <!-- Element Markup -->
    <!-- Edit Dialog -->
    <yeah-dialog-edit
      id="elEditDialog"
      collection='urlCollection'
      kwCollection='keywordCollection'
      route='/urlcollector'
      on-login-expired='_handleLoginExpired'
      on-edit-item-successful='_handleEditItemSuccessful'
      on-edit-item-failed='_handleEditItemFailed'>
    </yeah-dialog-edit>

    <!-- Delete Confirm Dialog -->
    <yeah-dialog-delete
      id='elDeleteDialog'
      collection='urlCollection'
      kwCollection='keywordCollection'
      route='/urlcollector'
      on-login-expired='_handleLoginExpired'
      on-delete-item-successful='_handleDeleteItemSuccessful'
      on-delete-item-failed='_handleDeleteItemFailed'>
    </yeah-dialog-delete>

    <!-- Searchview -->
    <yeah-search
      id='elSearch'
      searchStr='{{searchString}}'
      keywords='{{keywordCollection}}'
      on-search-input-changed='_handleSearchInputChanged'
      on-drop-down-selected-item='_handleDropDownSelectedItem'
      on-clear-search-input-fields='_handleClearSearchInputFields'>
    </yeah-search>

    <!-- Listview -->
    <div id='divOverview' class='style-overview'>
      <template id='templateOverview' is='dom-repeat' items='{{urlCollection}}' as='userObj'>
        <div id='collectionAllCard' class='style-all-cards'>
          <template is='dom-repeat' items='{{userObj}}' as='item'>
            <template is='dom-if' if='{{_hasItemId(item)}}'>
              <template is='dom-if' if='{{_searchForItems(item, searchString)}}'>
                <!-- Listview Item -->
                <yeah-listitem-url
                  item='[[item]]'
                  on-open-edit-dialog='_handleOpenEditDialog'
                  on-open-delete-dialog='_handleOpenDeleteDialog'>
                </yeah-listitem-url>
              </template>
            </template>
          </template>
        </div>
      </template>
    </div>
  </template>
</dom-module>
<!-- Element logic -->
<script>
  (function() {
    Polymer({
      is: 'yeah-urls',

      /**
       * PRIVATE FUNCTIONS
       */
      /**
       * handle expired Login
       * @private
       */
      _handleLoginExpired: function() {
        this.$.elDeleteDialog.toggleDialog();
        this.fire('login-expired');
      },

      /**
       * EDIT DIALOG
       */
      /**
       * handle edit item successful
       * @param e
       * @private
       */
      _handleEditItemSuccessful: function(e) {
        this.$.elEditDialog.toggleDialog();
        this.fire('edit-item-successful', e);
      },
      /**
       * handle edit item failed
       * @param e
       * @private
       */
      _handleEditItemFailed: function(e) {
        this.$.elEditDialog.toggleDialog();
        this.fire('edit-item-failed', e);
      },

      /**
       * DELETE DIALOG
       */
      /**
       * handle delete item successful
       * @param e
       * @private
       */
      _handleDeleteItemSuccessful: function(e) {
        this.$.elDeleteDialog.toggleDialog();
        this.fire('remove-item-successful', e);
      },
      /**
       * handle delete item failed
       * @param e
       * @private
       */
      _handleDeleteItemFailed: function(e) {
        this.$.elDeleteDialog.toggleDialog();
        this.fire('remove-item-failed', e);
      },

      /**
       * SEARCH VIEW
       */
      /**
       * Handle Search Input Value from Yeah-Search
       * @param e
       * @private
       */
      _handleSearchInputChanged: function(e) {
        this.searchString = e.detail.value;
      },
      /**
       * get selected drop down item
       * @param e {Object}
       * @private
       */
      _handleDropDownSelectedItem: function(e) {
        this.searchString = e.detail.value;
      },
      /**
       * clear search input
       */
      _handleClearSearchInputFields: function() {
        this.searchString = null;
      },

      /**
       * LIST VIEW
       */
      /**
       * Check if Item as an Id
       * @param item
       * @return {boolean}
       * @private
       */
      _hasItemId: function(item) {
        return item.hasOwnProperty('id');
      },
      /**
       * Search for matching Items
       * @param item
       * @param searchStr
       * @return {Object, Array}
       * @private
       */
      _searchForItems: function(item, searchStr) {
        if (searchStr === null ||typeof searchStr === 'undefined') {
          return item;
        } else {
          return item.value.toLowerCase().match(searchStr.toLowerCase()) || item.keywords.toUpperCase().match(searchStr.toUpperCase());
        }
      },

      /**
       * LIST VIEW ITEM
       */
      /**
       * Open Edit Dialog
       * @param e selected item
       * @private
       */
      _handleOpenEditDialog: function(e) {
        this.$.elEditDialog.toggleDialog(this, e.model.item);
      },
      /**
       * Open Delete Dialog
       * @param e selected item
       * @private
       */
      _handleOpenDeleteDialog: function(e) {
        var itemPosInColl = this._getPositionInCollection(e.model.item);
        this.$.elDeleteDialog.toggleDialog(this, e.model.item, itemPosInColl);
      },
      /**
       * Get Array Position from removed Item
       * @param obj
       * @private
       */
      _getPositionInCollection: function(obj) {
        for (var i = 0; i < this.urlCollection.length; i++) {
          for (var j = 0; j < this.urlCollection[i].length; j++) {
            if (obj === this.urlCollection[i][j]) {
              return i;
            }
          }
        }
        return -1;
      },

      /**
       * GLOBAL FUNCTIONS
       */
      /**
       * load items from Firebase
       */
      loadUrlCollection: function() {
        if (UserInfo.isLoginExpired(UserInfo.get(UserInfo.EXPIREDATE))) {
          this.fire('login-expired');
          return;
        }
        var id = UserInfo.get(UserInfo.USERID);
        FirebaseDAO.getInstance(this, id).loadCollections('/urlcollector', 'urlCollection', 'keywordCollection');
      },
      /**
       * clear URL listview
       */
      clearListview: function() {
        var listView = document.querySelector('#divOverview');
        if (listView !== null) listView.innerHTML = '';
      },
      /**
       * init global element variables
       */
      ready: function() {
        this.searchString = null;
        this.urlCollection = [];
        this.keywordCollection = [];
      }
    });
  })();
</script>
