<dom-module id="yeah-urls">
  <style>
    :host {
      display: block;
    }
    .search-container {
      width: 100%;
      @apply(--layout-horizontal);
    }
    .search-input {
      marign-left: 10px;
      margin-right: 5px;
      --paper-input-container-color: var(--text-primary-color);
      --paper-input-container-focus-color: var(--text-primary-color);
      --paper-input-container-input-color: var(--text-primary-color);
      @apply(--layout-flex);
    }
    .style-dropdown {
      margin-top: -8px;
      --paper-input-container-color: var(--text-primary-color);
      --paper-input-container-focus-color: var(--text-primary-color);
      --paper-input-container-input-color: var(--text-primary-color);
    }
    .clear-search {
      margin-top: 25px;
    }
    .style-overview {
      height: 620px;
      margin: 10px;
      overflow: auto;
    }
    .style-card-fab {
      position: absolute !important;
      top: 43px;
      right: 30px;
      z-index: 1;
    }
    .style-all-cards {
      margin-left: 5px;
      margin-top: 10px;
      margin-bottom: 10px;
      width: 98%;
    }
    .style-card {
      margin-top: 10px;
      border-radius: 4px;
      background-color: var(--text-primary-color);
    }
    paper-toolbar {
      word-wrap: break-word;
    }
    paper-input {
      margin-left: 15px;
      margin-right: 40px;
      width: 50%;
    }
    p{
      padding-left: 10px;
      padding-bottom: 5px;
      margin-top: 20px;
      margin-bottom: 5px;
      width: 90%;
    }
    a {
      word-wrap: break-word;
      margin: 10px 10px 0 0;
      padding: 10px 10px 0 0;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    @media all and (min-width: 0) and (max-width: 361px) and (orientation: portrait) {
      .style-overview {
        height: 470px;
      }
      .search-input {
        margin-top: -2px;
      }
      .use-keywords {
        margin-top: 32px;
      }
      .clear-search {
        margin-top: 23px;
      }
      .style-all-cards {
        margin-top: 15px;
      }
      .style-card-fab {
        position: absolute !important;
        top: 35px;
        right: 10px;
        z-index: 1;
      }
      paper-input {
        width: 90%;
      }
    }
    @media all and (min-width: 1601px) and (max-width: 1921px) {
      .style-overview {
        height: 725px;
        margin: 10px;
        overflow: auto;
      }
    }
  </style>
  <template>
    <!-- Delete Confirm Dialog -->
    <!-- ToDo: own Element needed w/ Item Object Property -->
    <paper-dialog
      id="confirmDeleteDialog"
      entry-animation="scale-up-animation"
      exit-animation="fade-out-animation"
      modal>
      <h2>Are you sure to delete this Item?</h2>
      <div class="buttons">
        <paper-button dialog-dismiss autofocus>Cancel</paper-button>
        <paper-button on-tap="remove">OK</paper-button>
      </div>
    </paper-dialog>

    <!-- Searchview -->
    <paper-material elevation="3">
      <paper-toolbar>
        <div class="search-container">
        <paper-input class="search-input" id="txtSearch" label="Search" type="text" value="{{searchStr}}"></paper-input>
        <paper-dropdown-menu label="Keywords" id="keywordsDropdown" class="style-dropdown" on-paper-dropdown-close="dropdownClosed">
          <paper-menu class="dropdown-content" selected="0">
            <template is="dom-repeat" items="[[keywords]]" as="keyword">
              <paper-item>[[keyword]]</paper-item>
            </template>
          </paper-menu>
        </paper-dropdown-menu>
        <paper-icon-button class="clear-search" icon="clear" on-tap="_clearSearch"></paper-icon-button>
      </div>
      </paper-toolbar>
    </paper-material>

    <!-- Listview -->
    <div id="divOverview" class="style-overview">
      <template id="templateOverview" is="dom-repeat" items="{{urlCollection}}" as="userObj">
        <div id="collectionAllCard" class="style-all-cards">
          <template is="dom-repeat" items="{{userObj}}" as="item">
            <template is="dom-if" if="{{_hasItemId(item)}}">
              <template is="dom-if" if="{{_searchForItems(item, searchStr)}}">
                <paper-material class="style-card" elevation="3">
                  <paper-toolbar>
                    <h3>Date:&nbsp;</h3><h3><span>{{item.date}}</span></h3>
                    <h3>,&nbsp;</h3><h3><span>{{item.time}}</span></h3>
                  </paper-toolbar>
                  <paper-fab class="style-card-fab" mini icon="clear" on-tap="_openConfirmDialog"></paper-fab>
                  <p><a href="{{item.value}}" target="_blank">{{item.value}}</a></p>
                  <p><strong>{{item.keywords}}</strong></p>
                </paper-material>
              </template>
            </template>
          </template>
        </div>
      </template>
    </div>
  </template>
</dom-module>

<script>
  (function() {
    Polymer({
      is: 'yeah-urls',

      /**
       * Load Items from Firebase
       */
      reloadOverview: function() {
        if (UserInfo.isLoginExpired(UserInfo.get(UserInfo.EXPIREDATE))) {
          this.fire('login-expired');
          return;
        }

        var id = UserInfo.get(UserInfo.USERID);
        var that = this;

        var rootRef = new Firebase('https://yeah-url-extension.firebaseio.com/' + id + '/urlcollector');
        rootRef.on('value', function(snapshot) {

          that.urlCollection = [];

          snapshot.forEach(function(child) {
            that.push('urlCollection', that._extractKeywords(child.val()));
          });
        });
      },

      /**
       * extract keywords from urlcollections
       * @param items
       * @private
       */
      _extractKeywords: function(items) {
        var kw = items[0].keywords;
        if (this.keywords.length === 0) {
          this.push('keywords', "");
        }
        if (this.keywords.indexOf(kw) === -1) {
          this.push('keywords', kw);
        }
        return items;
      },

      /**
       * Remove selected Item from Firebase
       * @param e
       */
      remove: function(e) {
        if (UserInfo.isLoginExpired(UserInfo.get(UserInfo.EXPIREDATE))) {
          this.fire('login-expired');
          return;
        }

        var model = e.model;
        var urlObj = model.item;

        var id = (urlObj.id - 1);
        var objId = urlObj.objId;
        var that = this;

        this._removeFromFirebase(id, objId)
          .then(function(obj) {
            that.fire('remove-item-successful', obj);
            that.$.confirmDeleteDialog.toggle();
            that.reloadOverview();
          })
          .catch(function(err) {
            that.fire('remove-item-failed', err);
            that.$.confirmDeleteDialog.toggle();
          });
      },

      /**
       * Remove it!
       * @param id
       * @param objId
       * @return {Promise}
       * @private
       */
      _removeFromFirebase: function(id, objId) {
        return new Promise(function(resolve, reject) {
          var userId = UserInfo.get(UserInfo.USERID);
          var ref = new Firebase('https://yeah-url-extension.firebaseio.com/' + userId + '/urlcollector/' + objId + '/' + id);

          var onComplete = function(error) {
            if (error) reject(error);
            else resolve({'value':'remove successful'});
          };

          ref.remove(onComplete);
        });
      },

      /**
       * Check if Item as an Id
       * @param item
       * @return {boolean}
       * @private
       */
      _hasItemId: function(item) {
        return item.hasOwnProperty('id');
      },

      /**
       * Search for matching Items
       * @param item
       * @param searchStr
       * @return {Object, Array}
       * @private
       */
      _searchForItems: function(item, searchStr) {
        if (searchStr === null ||typeof searchStr === 'undefined') {
          return item;
        } else {
          return item.value.toLowerCase().match(searchStr.toLowerCase()) || item.keywords.toUpperCase().match(searchStr.toUpperCase());
        }
      },

      /**
       * Clear Search Input
       * @private
       */
      _clearSearch: function() {
        this.$.txtSearch.value = '';
        this.$.keywordsDropdown.contentElement.selected = 0
      },

      /**
       * Clear Url List
       */
      clearListview: function() {
        var listView = document.querySelector('#divOverview');
        if (listView !== null) listView.innerHTML = '';
      },

      /**
       * Set selected Dropdown Menu Item to Search Input
       */
      dropdownClosed: function() {
        var searchInput = this.$.txtSearch;
        // Hack the planet ;-)
        var menuItemList = this.$$('paper-dropdown-menu').children[0].children[1].children[0].children[0].children[0].children[0].children;

        for (var i = 0; i < menuItemList.length; i++) {
          if (menuItemList[i].classList.contains('iron-selected')) {
            searchInput.value = menuItemList[i].innerHTML.trim();
            break;
          }
        }
      },

      /**
       * open confirm dialog to delete an item
       */
      _openConfirmDialog: function(e) {
        this.$.confirmDeleteDialog.toggle();
      },

      /**
       * Init Url Collection
       */
      ready: function() {
        this.urlCollection = [];
        this.keywords = [];
      }
    });
  })();
</script>
